/* ==========================================================================
   ELÇİ — SERVICES (TEK KAYNAK, TEK TASARIM, İKİ SAYFAYA ORTAK)
   - JSON: /assets/data/services.json   (şema: { title?:string, items: [...] })
   - Kart sınıfları: .s-card, .s-icon, .s-title, .s-text, .s-link  (index ile birebir)
   - FA Pro ikonlarında otomatik sprite fallback
   - Cache-bust: ?v=window.__ASSET_HASH__ || Date.now()
   ========================================================================== */

(function(){
  const JSON_URL = '/assets/data/services.json';

  /** küçük yardımcılar **/
  const assetHash = (window.__ASSET_HASH__ || Date.now());
  const fetchUrl  = `${JSON_URL}?v=${assetHash}`;

  const qs  = (sel, el=document) => el.querySelector(sel);
  const qsa = (sel, el=document) => Array.from(el.querySelectorAll(sel));

  function normItems(data){
    // {items:[...]} veya doğrudan dizi destekle
    if(Array.isArray(data)) return data;
    if(data && Array.isArray(data.items)) return data.items;
    return [];
  }

  function iconHTML(icon){
    // Destek: '#i-xray' veya 'i-xray' (sprite) ya da 'fa-solid fa-...' (FA)
    if(!icon) return `<svg viewBox="0 0 24 24"><use href="#i-article"/></svg>`;
    if(icon.startsWith('#i-')) return `<svg viewBox="0 0 24 24"><use href="${icon}"/></svg>`;
    if(icon.startsWith('i-'))  return `<svg viewBox="0 0 24 24"><use href="#${icon}"/></svg>`;
    if(icon.includes('fa-')){
      // FA Pro’larda boş görünmeyi engelle: pro değilse sprite fallback
      const maybePro = /fa-(?:scalpel|x-ray|syringe-dropper|user-doctor|hospital-user|prescription-bottle)/.test(icon);
      if(maybePro) return `<svg viewBox="0 0 24 24"><use href="#i-clipboard"/></svg>`;
      return `<i class="${icon}" aria-hidden="true"></i>`;
    }
    return `<svg viewBox="0 0 24 24"><use href="#i-article"/></svg>`;
  }

  function cardTemplate(item){
    const href = item.href || (item.id ? (`#${item.id}`) : '#');
    return `
      <article class="s-card" ${item.id ? `id="${item.id}"` : ''}>
        <span class="s-icon" aria-hidden="true">${iconHTML(item.icon)}</span>
        <h3 class="s-title">${item.title || 'Hizmet'}</h3>
        <p class="s-text">${item.summary || item.text || ''}</p>
        <a class="s-link" href="${href}">Detaylı Bilgi</a>
      </article>`;
  }

  /** INDEX: <section id="services" data-json="..." data-limit="6" data-mode="split|all"> **/
  function initIndex(){
    const host = qs('#services');
    if(!host) return;

    const limit = parseInt(host.getAttribute('data-limit') || '0', 10) || 0;
    const mode  = (host.getAttribute('data-mode') || 'split').toLowerCase();

    const featuredWrap = qs('#servicesFeatured');
    const moreWrap     = qs('#servicesMoreWrap');
    const moreTrack    = qs('#servicesTrack');
    const tFallback    = qs('#services-fallback');

    function renderFallback(){
      if(!tFallback) return;
      const frag   = tFallback.content.cloneNode(true);
      const tempG  = frag.querySelector('.services-grid');
      const tempM  = frag.querySelector('.services-more');
      if(featuredWrap && tempG)  featuredWrap.replaceWith(tempG);
      if(moreWrap && tempM){ moreWrap.replaceWith(tempM); }
    }

    function wireScroll(){
      if(!moreWrap || !moreTrack) return;
      const prev = qs('#svcPrev');
      const next = qs('#svcNext');
      const by   = ()=> Math.max(moreTrack.clientWidth*0.95, 300);
      prev && prev.addEventListener('click', ()=> moreTrack.scrollBy({left:-by(), behavior:'smooth'}));
      next && next.addEventListener('click', ()=> moreTrack.scrollBy({left: by(), behavior:'smooth'}));
      moreTrack.setAttribute('tabindex','0');
      moreTrack.addEventListener('keydown', (e)=>{
        const d=by();
        if(e.key==='ArrowLeft'){ e.preventDefault(); moreTrack.scrollBy({left:-d, behavior:'smooth'}); }
        if(e.key==='ArrowRight'){ e.preventDefault(); moreTrack.scrollBy({left: d,  behavior:'smooth'}); }
      });
    }

    fetch(fetchUrl, {cache:'no-store'})
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(json => {
        const items = normItems(json);
        if(!items.length){ renderFallback(); return; }

        // Başlık override
        const h2 = host.querySelector('h2');
        if(json.title && h2) h2.textContent = json.title;

        if(mode==='all' || !limit){
          if(featuredWrap) featuredWrap.innerHTML = items.map(cardTemplate).join('');
          if(moreWrap)     moreWrap.style.display='none';
          return;
        }

        const first = items.slice(0, limit);
        const rest  = items.slice(limit);
        if(featuredWrap) featuredWrap.innerHTML = first.map(cardTemplate).join('');
        if(rest.length && moreWrap && moreTrack){
          moreTrack.innerHTML = rest.map(cardTemplate).join('');
          moreWrap.style.display='block';
          wireScroll();
        }else if(moreWrap){
          moreWrap.style.display='none';
        }
      })
      .catch(()=> renderFallback());
  }

  /** HİZMETLER: arama + kategori (opsiyonel) + aynı kart tasarımı
      Gerekli DOM:
        #svcSections (içerik),
        #svcToc (sol TOC),
        #chipBar (üst chipler),
        #svcSearch (arama)
      JSON’da category/kategori yoksa hepsi “Diğer” grubuna düşer ve yine tam listelenir.
  **/
  function initServicesPage(){
    const container = qs('#svcSections');
    if(!container) return; // hizmetler sayfasında değiliz
    const toc      = qs('#svcToc');
    const chipBar  = qs('#chipBar');
    const search   = qs('#svcSearch');
    const fallback = qs('#svcFallback');

    let ITEMS = [];
    let CATS  = [];
    let ACTIVE = 'Tümü';
    let Q = '';

    const pick = (obj, ...keys) => keys.map(k=>obj?.[k]).find(v=> v!=null);

    function buildCats(){
      const set = new Set(ITEMS.map(i => (pick(i,'category','kategori') || 'Diğer').trim()));
      CATS = ['Tümü', ...Array.from(set)];
    }
    function catId(c){ return ('cat-'+c.toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]+/g,'')); }

    function renderTOC(){
      if(!toc) return;
      toc.innerHTML = CATS.map((c,i)=>`
        <li><a href="#${catId(c)}" class="${i===0?'active':''}" data-cat="${c}">
          <i class="fa-regular fa-folder-open"></i> <span>${c}</span>
        </a></li>`).join('');
      qsa('a', toc).forEach(a=>{
        a.addEventListener('click', ()=>{
          qsa('a', toc).forEach(x=>x.classList.remove('active'));
          a.classList.add('active');
          ACTIVE = a.dataset.cat;
          renderAll();
          const t = document.getElementById(catId(ACTIVE));
          if(t) t.scrollIntoView({behavior:'smooth', block:'start'});
        });
      });
    }

    function renderChips(){
      if(!chipBar) return;
      chipBar.innerHTML = CATS.map(c => `<button class="chip ${c===ACTIVE?'active':''}" data-cat="${c}">${c}</button>`).join('');
      qsa('.chip', chipBar).forEach(btn=>{
        btn.addEventListener('click', ()=>{
          ACTIVE = btn.dataset.cat;
          renderAll();
          const t = document.getElementById(catId(ACTIVE));
          if(t) t.scrollIntoView({behavior:'smooth', block:'start'});
        });
      });
    }

    function filtered(list){
      return list.filter(it=>{
        const cat = (pick(it,'category','kategori') || 'Diğer');
        const catOk = (ACTIVE==='Tümü') || (cat===ACTIVE);
        const ttl = (it.title||'').toLowerCase();
        const sum = (it.summary||it.text||'').toLowerCase();
        const qOk = !Q || ttl.includes(Q) || sum.includes(Q);
        return catOk && qOk;
      });
    }

    function renderSections(){
      if(!container) return;
      const groups = {};
      (ACTIVE==='Tümü' ? CATS.slice(1) : [ACTIVE]).forEach(c=> groups[c]=[]);
      ITEMS.forEach(it=>{
        const cat = (pick(it,'category','kategori') || 'Diğer');
        if(groups[cat]!==undefined) groups[cat].push(it);
      });

      let html = '';
      const catsToRender = (ACTIVE==='Tümü' ? Object.keys(groups) : [ACTIVE]);
      catsToRender.forEach(cat=>{
        const list = filtered(groups[cat]);
        if(!list.length) return;
        html += `
          <section class="svc-section" id="${catId(cat)}" aria-label="${cat}">
            <h2>${cat}</h2>
            <div class="services-grid">
              ${ list.map(cardTemplate).join('') }
            </div>
          </section>`;
      });
      if(!html){
        html = `<section class="svc-section"><h2>Sonuç bulunamadı</h2><p class="muted">Anahtar sözcükleri kısaltarak tekrar deneyin.</p></section>`;
      }
      container.innerHTML = html;
    }

    function renderAll(){ renderChips(); renderSections(); }

    function renderFallback(){
      if(!fallback || !container) return;
      const frag = fallback.content?.cloneNode(true);
      container.innerHTML = '';
      if(frag) container.appendChild(frag);
      CATS = ['Tümü','Öne Çıkanlar']; ACTIVE='Tümü';
      renderChips(); renderTOC();
    }

    search && search.addEventListener('input', (e)=>{
      Q = String(e.target.value||'').trim().toLowerCase();
      renderSections();
    });

    fetch(fetchUrl, {cache:'no-store'})
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(json => {
        const items = normItems(json);
        if(!items.length){ renderFallback(); return; }
        ITEMS = items.map(it=>{
          // FA Pro olursa sprite fallback
          if(it.icon && /fa-/.test(it.icon)){
            const pro = /fa-(?:scalpel|x-ray|syringe-dropper|user-doctor|hospital-user|prescription-bottle)/.test(it.icon);
            return pro ? {...it, icon:'#i-clipboard'} : it;
          }
          return it;
        });
        buildCats(); renderTOC(); renderAll();
      })
      .catch(()=> renderFallback());
  }

  // Çalıştır
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', () => { initIndex(); initServicesPage(); });
  }else{
    initIndex(); initServicesPage();
  }
})();
